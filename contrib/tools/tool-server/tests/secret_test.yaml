suite: test tool-server secret
templates:
  - secret.yaml
tests:
  - it: should not render secret when no api key provided
    asserts:
      - hasDocuments:
          count: 0

  - it: should render secret with new naming convention
    set:
      openai:
        apiKey: "test-key"
    release:
      name: tool-server
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: tool-server-api-key
      - equal:
          path: type
          value: Opaque
      - equal:
          path: data.OPENAI_API_KEY
          value: dGVzdC1rZXk=
      - hasDocuments:
          count: 1

  - it: should have correct labels
    set:
      openai:
        apiKey: "test-key"
    release:
      name: tool-server
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: tool-server
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: tool-server
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm